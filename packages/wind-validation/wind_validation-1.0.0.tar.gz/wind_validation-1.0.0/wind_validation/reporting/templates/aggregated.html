<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <!-- TODO: for stability would useful to include all the links from static files locally -->
    <script src="https://cdn.jsdelivr.net/npm/sorttable@1.0.2"></script>
    <title>{{ title }}</title>
    {{ md_css }}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://leaflet.github.io/Leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://leaflet.github.io/Leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css"
        integrity="sha512-07I2e+7D8p6he1SIM+1twR5TIrhUQn9+I6yjqD53JQjFiMf8EtC93ty0/5vJTZGF8aAocvHYNEDJajGdNx1IsQ=="
        crossorigin="" />
</head>

<body>
    <div id="logo-div">
        <img id="dtu-logo" src="data:image/png;base64,{{logos[0]}}">
        <img id="windsider-logo" src="data:image/png;base64,{{logos[1]}}">
    </div>

    <div id="parent" class="js-toc-content">

        <div id="sidebar">
            <h3>Table of Contents</h3>
            <div class="js-toc"></div>
            <br>
        </div>
        <div id="main-content">
            <h1 class="center">{{ title }}</h1>

            <p>
                The {{ obs }} vs {{ mod }} validation was produced on {{ meta.date.date().isoformat() }} at {{
                meta.date.time().isoformat(timespec="seconds") }} {% if meta.user != "" %} by {{ meta.user }} {% endif
                %} using wind-validation version: {{ meta.version }}. This report first gives a validation summary
                followed by detailed validation for each of the {{ site_results.shape[0] }} points
                {% if site_results.index.shape[0] != site_results.index.unique().shape[0] %} obtained at
                {{ site_results.index.unique().shape[0] }} masts{% endif %}.
            </p>

            <h2 id='h-1' slot='h-1'>Summary Table</h2>

            <table class="center">
                <caption>
                    Table 1: The aggregated results of the {{ obs }} vs {{ mod }} validation for {{
                    site_results.shape[0] }} points. <i>Observed</i> and <i>Predicted</i> are the mean observed and
                    modelled values, respectively. <i>ME</i> is the mean error,
                    <i>RMSE</i> is the root mean square error, <i>MAE</i> and <i>MAPE</i> are the mean absolute error.
                    The power density values are calculated for standard air density 1.225 kg/m<sup>3</sup>.
                </caption>

                <tr>
                    <th> Variable </th>
                    <th> Observed </th>
                    <th> Predicted </th>
                    <th> Mean error (bias) </th>
                    <th> Mean abs error </th>
                    <th> Mean abs percentage error </th>
                </tr>
                <tr>
                    <td>Wind speed</td>
                    <td>{{ '{0:0.1f}'.format(agg_results.obs_wind_speed_mean) }} m/s</td>
                    <td>{{ '{0:0.1f}'.format(agg_results.mod_wind_speed_mean) }} m/s</td>
                    <td>{{ '{0:0.1f}'.format(agg_results.wind_speed_me) }} m/s</td>
                    <td>{{ '{0:0.1f}'.format(agg_results.wind_speed_mae) }} m/s</td>
                    <td>{{ '{0:0.1f}'.format(agg_results.wind_speed_mape) }} %</td>
                </tr>
                <tr>
                    <td>Power density</td>
                    <td>{{ '{0:0.1f}'.format(agg_results.obs_power_density_mean) }} W/m<sup>2</sup></td>
                    <td>{{ '{0:0.1f}'.format(agg_results.mod_power_density_mean) }} W/m<sup>2</sup></td>
                    <td>{{ '{0:0.1f}'.format(agg_results.power_density_me) }} W/m<sup>2</sup></td>
                    <td>{{ '{0:0.1f}'.format(agg_results.power_density_mae) }} W/m<sup>2</sup></td>
                    <td>{{ '{0:0.1f}'.format(agg_results.power_density_mape) }} %</td>
                </tr>
            </table>

            <h2 id='h-2' slot='h-2'>Summary map</h2>
            <div id='map'></div>

            <h2 id='h-3' slot='h-3'>Summary figures</h2>
            <figure>
                {{ mae_hist }}
                <figcaption>
                    Fig. 1: Histogram of mean error of wind speed for all sites.
                </figcaption>
            </figure>

            <figure>
                {{ power_mape_hist }}
                <figcaption>
                    Fig. 2: Histogram of mean error of power density for all sites.
                </figcaption>
            </figure>

            {% for maep in mapes %}
            <figure>
                {{ maep }}
                <figcaption>
                    Fig. 3.{{loop.index}}: Wind speed error in percent per site.
                </figcaption>
            </figure>
            {% endfor %}

            <h2 id='h-4' slot='h-4'>Detailed validation</h2>

            <table class="sortable center">
                <caption>
                    Table 2: detailed all-sector results metrics for each of the {{ site_results.index|length }} sites.
                    {{ obs }} vs {{ mod }} wind resource validation.
                </caption>

                <tr>
                    <th>Position/Site</th>
                    <th>Wind speed error [%]</th>
                    <th>Power density error [%]</th>
                    <th>Wind speed [m/s]</th>
                    <th>Power density [W/m<sup>2</sup>]</th>
                    <th>Height above surface [m]</th>
                </tr>

                {% for index,st in iterrow %}
                <tr>
                    <td>{{ index }}</td>
                    <td>{{ '{0:0.1f}'.format(st.wind_speed_mpe) }}</td>
                    <td>{{ '{0:0.1f}'.format(st.power_density_mpe) }}</td>
                    <td>{{ '{0:0.1f}'.format(st.obs_wind_speed_mean) }}</td>
                    <td>{{ '{0:0.1f}'.format(st.obs_power_density_mean) }}</td>
                    <td>{{ '{0:0.1f}'.format(st.height) }}</td>
                </tr>
                {% endfor %}
            </table>

            <h2 id='h-5' slot='h-5'>References</h2>
            DTU Wind Energy, Wind-validation, (2021), GitLab repository,
            <a
                href="https://gitlab.windenergy.dtu.dk/windsider/wind-validation/">https://gitlab.windenergy.dtu.dk/windsider/wind-validation/</a>

        </div>

    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>
    <script>
        tocbot.init({
            // Where to render the table of contents.
            tocSelector: '.js-toc',
            // Where to grab the headings to build the table of contents.
            contentSelector: '.js-toc-content',
            // Which headings to grab inside of the contentSelector element.
            headingSelector: 'h2',
            // For headings inside relative or absolute positioned containers within content.
            hasInnerContainers: true,
        });
    </script>
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"
        integrity="sha512-A7vV8IFfih/D732iSSKi20u/ooOfj/AGehOKq0f4vLT1Zr2Y+RX7C+w8A1gaSasGtRUZpF/NZgzSAu4/Gc41Lg=="
        crossorigin=""></script>
    <script type='text/javascript'
        src='https://leaflet.github.io/Leaflet.markercluster/dist/leaflet.markercluster-src.js'></script>
    <script type='text/javascript'>
        var tiles = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 17,
            attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
        });
        latlng = new L.LatLng(50, 5);
        var map = new L.Map('map', {
            center: latlng,
            zoom: 2,
            layers: [tiles]
        });
        var markeroptions = {
            color: '#ff9933',
            fillColor: '#ff9933',
            fillOpacity: 1,
            opacity: 0,
            weight: 12,
            radius: 6
        };

        markers = [
            {% for index, st in iterrow %}
        ['{{ index }}', {{ st.south_north }}, {{ st.west_east }}, {{ st.height }}, {{ st.power_density_mpe | round(1) }}],
            {% endfor %}
        ];

        var markers2 = new L.markerClusterGroup({
            singleMarkerMode: true,
            chunkedLoading: true
        });

        function populate() {
            for (var i = 0; i < markers.length; ++i) {
                var text = '<p>Position: ' + markers[i][1].toFixed(3) + 'N, ' + + markers[i][2].toFixed(3) + 'S, ' + markers[i][3] + ' m agl</p><p>Mean Power Density Error: ' + markers[i][4] + ' (%)</p>';
                markers2.addLayer(new L.circleMarker([markers[i][1], markers[i][2]], markeroptions).bindPopup('<h4>' + markers[i][0] + '</h4>' + text));
            }
            return false;
        }
        map.addLayer(markers2);

        populate();
    </script>
</body>

</html>
