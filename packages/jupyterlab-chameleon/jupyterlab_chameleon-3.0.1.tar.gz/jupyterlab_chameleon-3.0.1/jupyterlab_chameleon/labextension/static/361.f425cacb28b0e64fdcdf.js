"use strict";(self.webpackChunk_chameleoncloud_jupyterlab_chameleon=self.webpackChunk_chameleoncloud_jupyterlab_chameleon||[]).push([[361],{361:(e,t,n)=>{n.r(t),n.d(t,{default:()=>be});var i=n(504),a=n(149),r=n(859),s=n(998),o=n(698),c=n.n(o),l=n(185),d=n(111),h=n(122),u=n(403),p=n(850),m=n(706);class g extends s.DirListing.Renderer{constructor(e){super(),this._artifactRegistry=e}populateHeaderNode(e){super.populateHeaderNode(e),this._headerIndicator||(this._headerIndicator=document.createElement("div"),this._headerIndicator.className="chi-Something")}updateItemNode(e,t,n){super.updateItemNode(e,t,n);const i=this._artifactRegistry.getArtifactSync(t.path);if(i&&i.uuid){e.setAttribute("data-artifact-id",i.uuid);const t=[`Artifact ID: ${i.uuid}`,`Artifact contents: ${i.versions[i.versions.length-1].contents.urn}`,`Artifact ownership: ${i.ownership}`].join("\n");e.title+=`\n${t}`}else delete e.dataset.artifactId}}var f=n(695),y=n(626);const b=["title","short_description","long_description","authors","visibility"];class w{constructor(){this._serverSettings=f.ServerConnection.makeSettings(),this._artifacts=[],this._artifactsFetched=!1}async createArtifact(e){const t=await f.ServerConnection.makeRequest(_.getArtifactsUrl(this._serverSettings),{method:"POST",body:JSON.stringify(e)},this._serverSettings),n=await _.handleCreateResponse(t,e);return this._updateArtifacts(n),n}async newArtifactVersion(e){const t=await f.ServerConnection.makeRequest(_.getArtifactsUrl(this._serverSettings),{method:"POST",body:JSON.stringify(e)},this._serverSettings),n=await _.handleNewVersionResponse(t);return e.versions.push(n),this._updateArtifacts(e),n}async updateArtifact(e){const t=e,n=b.map((e=>this._patchFor(e,t[e]))),i={uuid:e.uuid,patches:n},a=await f.ServerConnection.makeRequest(_.getArtifactsUrl(this._serverSettings),{method:"PUT",body:JSON.stringify(i)},this._serverSettings),r=await _.handleCreateResponse(a,e);return this._updateArtifacts(r),r}async getArtifacts(){if(!this._artifactsFetched){this._artifactsFetchPromise||(this._artifactsFetchPromise=f.ServerConnection.makeRequest(_.getArtifactsUrl(this._serverSettings),{method:"GET"},this._serverSettings).then(_.handleListResponse));try{this._artifacts=await this._artifactsFetchPromise,this._artifactsFetched=!0}finally{delete this._artifactsFetchPromise}}return this._artifacts}async getArtifact(e){return(await this.getArtifacts()).find((t=>t.path===e))}getArtifactSync(e){return this._artifacts.find((t=>t.path===e))}hasArtifactSync(e){return!!this.getArtifactSync(e)}_updateArtifacts(e){const t=this._artifacts.findIndex((({path:t})=>t===e.path));this._artifacts=t>=0?this._artifacts.slice(0,t).concat([e],this._artifacts.slice(t+1)):this._artifacts.concat([e])}_patchFor(e,t){return null!==t?{op:"replace",path:`/${e}`,value:t}:{op:"remove",path:`/${e}`}}}var _;!function(e){e.getContentsUrl=function(e){const t=[e.baseUrl,"chameleon","contents"];return y.URLExt.join.call(y.URLExt,...t)},e.getArtifactsUrl=function(e){const t=[e.baseUrl,"chameleon","artifacts"];return y.URLExt.join.call(y.URLExt,...t)},e.handleListResponse=async function(e){const{artifacts:t}=await e.json();if(!t||!Array.isArray(t))throw new f.ServerConnection.ResponseError(e,"Malformed response");return t},e.handleUpdateResponse=async function(e){if(e.status>299){const t=`HTTP error ${e.status} occurred updating the artifact`;throw new f.ServerConnection.ResponseError(e,t)}},e.handleNewVersionResponse=async function(e){if(!e.ok){let t=JSON.stringify((await e.json()).error);t||(t="Unknown");const n=`An error occurred creating the artifact version: ${t}`;throw new f.ServerConnection.ResponseError(e,n)}return await e.json()},e.handleCreateResponse=async function(e,t){if(!e.ok){let t=JSON.stringify((await e.json()).error);t||(t="Unknown");const n=`An error occurred creating the artifact: ${t}`;throw new f.ServerConnection.ResponseError(e,n)}const n=await e.json();return{uuid:n.uuid,title:n.title,short_description:n.short_description,long_description:n.long_description,tags:n.tags,authors:n.authors,linked_projects:n.linked_projects.map((e=>({urn:e}))),reproducibility:n.reproducibility,created_at:n.created_at,updated_at:n.updated_at,owner_urn:n.owner_urn,visibility:n.visibility,versions:n.versions,ownership:t.ownership,path:t.path}},e.handleContentsResponse=async function(e){if(e.status>299){const t=`HTTP error ${e.status} occured uploading content`;throw new f.ServerConnection.ResponseError(e,t)}return await e.json()}}(_||(_={}));var v,C=n(797);!function(e){e.PUBLIC="public",e.PRIVATE="private"}(v||(v={}));const E=new C.Token("@jupyterlab_zenodo:IZenodoRegistry");var k,S=n(539),A=n(669),I=n(271);!function(e){e.CONFIRM_FORM="confirm-form",e.ARTIFACT_FORM="artifact-form",e.WAITING="waiting",e.SUCCESS="success"}(k||(k={}));class F extends I.Component{render(){return I.createElement("div",{className:"chi-ArtifactForm-text"},I.createElement("h2",null,"Package new artifact"),I.createElement("p",null,"Packaging your work as an ",I.createElement("i",null,"artifact")," makes it easier to share your Notebook(s) and related files with others. A packaged experiment:"),I.createElement("ul",null,I.createElement("li",null,"can by “replayed” by any Chameleon user"),I.createElement("li",null,"is displayed in"," ",I.createElement("a",{href:this.props.urlFactory.indexUrl(),rel:"noreferrer",target:"_blank"},"Chameleon Trovi")," ","(artifact sharing system)"),I.createElement("li",null,"is initially private to you, but can be shared, either with specific projects, or all users"),I.createElement("li",null,"supports versioning, if you ever want to make changes")),I.createElement("p",null,"To learn more about Trovi, and artifact packaging, please refer to the"," ",I.createElement("a",{href:"https://chameleoncloud.readthedocs.io",rel:"noreferrer",target:"_blank"},"Chameleon documentation"),"."))}}class x extends I.Component{render(){return I.createElement("div",{className:"chi-ArtifactForm-text"},I.createElement("h2",null,"Your artifact was successfully packaged."),this.props.artifact&&I.createElement("p",null,"You can view your artifact at any time on"," ",I.createElement("a",{href:this.props.urlFactory.detailUrl(this.props.artifact.uuid),target:"_blank",rel:"noreferrer"},"Trovi"),"."),I.createElement("p",null,"You may now close this window."))}}class B extends I.Component{render(){return I.createElement("div",{className:"chi-ArtifactForm-text"},I.createElement("h2",null,"Create new artifact version"),I.createElement("p",null,"When you create a new version of an existing package, your package’s files are re-uploaded and then saved as a new launchable artifact. Creating a new version makes sense if you make adjustments to your code or Notebooks, perhaps fixing a bug or adding additional capabilities or functionality."),I.createElement("p",null,"If you want to start a new packaged artifact, you can do so by moving the files you want included in the package to their own directory, outside of any already-published package directories."),I.createElement("p",null,"All package versions are displayed in Trovi along with your existing artifact title, description, and other metadata. You can optionally edit this metadata before saving your new version."))}}class N extends I.Component{render(){return I.createElement("div",{className:"chi-ArtifactForm-text"},I.createElement("h2",null,"Edit artifact"))}}class R extends I.Component{render(){return I.createElement("div",{className:"chi-ArtifactForm-text"},I.createElement("h2",null,"Your artifact has been updated."),I.createElement("p",null,"You may now close this window."))}}class T extends I.Component{render(){return I.createElement("div",null,I.createElement("h2",null,"A new version of your artifact was created."),this.props.artifact&&I.createElement("p",null,"You can view your artifact at any time on"," ",I.createElement("a",{href:this.props.urlFactory.detailUrl(this.props.artifact.uuid),target:"_blank",rel:"noreferrer"},"Trovi"),"."),I.createElement("p",null,"You may now close this window."))}}class U extends I.Component{constructor(e){super(e);const t=this.props.list;this.state={list:t.length>0?t:[this.props.newObjectGenerator()]}}addItem(){return()=>{let e=[...this.props.list,this.props.newObjectGenerator()];return this.props.artifactUpdater(e)}}removeItem(e){return()=>{let t=[...this.props.list];return t.splice(e,1),this.props.artifactUpdater(t)}}updateItem(e){return t=>n=>{const i=n.target.value;let a=[...this.props.list];return a[e]=Object.assign(Object.assign({},a[e]),{[t]:i}),this.props.artifactUpdater(a)}}getListForComponents(){return this.props.list.length<1?[this.props.newObjectGenerator()]:this.props.list}render(){return I.createElement(S.cw,{className:"chi-ListComponent",label:this.props.label,labelInfo:this.props.labelInfo,helperText:this.props.helperText},this.getListForComponents().map(((e,t)=>I.createElement("div",{className:"chi-ListComponent-Item",key:t},this.props.newComponentGenerator(e,this.updateItem(t),this.removeItem(t))))),I.createElement(S.zx,{small:!0,onClick:this.addItem(),icon:"plus"},"Add author"))}}class j extends I.Component{constructor(e){super(e)}hasAnyInput(){const e=this.props.author;return""!==e.email||""!==e.affiliation||""!==e.full_name}render(){const e=this.props.author;return I.createElement(S.eQ,{fill:!0},I.createElement(S.BZ,{placeholder:"Full name",required:this.hasAnyInput(),value:e.full_name,onChange:this.props.onFieldChange("full_name")}),I.createElement(S.BZ,{placeholder:"Email address",required:this.hasAnyInput(),value:e.email,onChange:this.props.onFieldChange("email")}),I.createElement(S.BZ,{placeholder:"Affiliation",required:this.hasAnyInput(),value:e.affiliation,onChange:this.props.onFieldChange("affiliation")}),I.createElement(S.zx,{icon:"trash",small:!0,onClick:()=>this.props.onDelete()},"Delete"))}}class M extends I.Component{isUploadForm(){return"upload"===this.props.workflow}isNewVersionForm(){return!!this.props.artifact.uuid&&this.isUploadForm()}render(){const e=[];let t,n;return this.isUploadForm()?(t=I.createElement("span",null,"Upload: ",I.createElement("code",null,this.props.artifact.path,"/")),n="upload"):(t=I.createElement("span",null,"Save"),n="floppy-disk"),this.isNewVersionForm()||(e.push(I.createElement(S.cw,{label:"Title",labelFor:"chi-ArtifactForm-title",labelInfo:"(required)"},I.createElement(S.BZ,{id:"chi-ArtifactForm-title",required:!0,placeholder:"The title of your experiment",value:this.props.artifact.title,onChange:this.props.onChange("title")}))),e.push(I.createElement(S.cw,{label:"Short description",labelFor:"chi-ArtifactForm-short-description",labelInfo:"(required)"},I.createElement(S.BZ,{id:"chi-ArtifactForm-short-description",placeholder:"A short description of your experiment",required:!0,value:this.props.artifact.short_description,onChange:this.props.onChange("short_description")}))),e.push(I.createElement(S.cw,{label:"Long description",labelFor:"chi-ArtifactForm-long-description",helperText:"Supports GitHub-flavored markdown"},I.createElement(S.Kx,{id:"chi-ArtifactForm-long-description",fill:!0,growVertically:!0,style:{minHeight:"5rem"},value:this.props.artifact.long_description,onChange:this.props.onChange("long_description")}))),e.push(I.createElement(S.cw,{label:"Visibility",helperText:"Public artifacts are visible to any user, private artifacts are visible only to you and those you have shared it with.",labelFor:"chi-ArtifactForm-visibility"},I.createElement(S.Lu,{id:"chi-ArtifactForm-visibility",title:"Allow other users to view your artifact",defaultValue:this.props.artifact.visibility,onChange:this.props.onChange("visibility")},I.createElement("option",{value:v.PRIVATE},"private"),I.createElement("option",{value:v.PUBLIC},"public")))),e.push(I.createElement(U,{label:"Authors",helperText:"List any individuals you would like to credit. This is purely for display purposes and does not control who is able to edit the artifact.",artifactUpdater:this.props.onListChange("authors"),newComponentGenerator:(e,t,n)=>I.createElement(j,{author:e,onFieldChange:t,onDelete:n}),newObjectGenerator:()=>({full_name:"",email:"",affiliation:""}),list:[...this.props.artifact.authors]}))),I.createElement("form",{onSubmit:this.props.onSubmit,style:this.props.formVisibility},this.props.error&&I.createElement("div",{className:"chi-ArtifactSharing-ErrorMessage"},this.props.error),this.props.formText,e,I.createElement("div",{className:"chi-ArtifactSharing-FormActions"},I.createElement(S.zx,{type:"submit",icon:n,large:!0,intent:A.Intent.PRIMARY},t)))}}M.hidden={display:"none"},M.block={display:"block"};class O extends I.Component{constructor(e){super(e),this._allStates=Object.values(k),this.state={artifact:this.props.initialArtifact,currentState:k.ARTIFACT_FORM,errorMessage:null,waitMessage:null},this.onSubmit=this.onSubmit.bind(this),this.handleChange=this.handleChange.bind(this),this.handleListChange=this.handleListChange.bind(this)}handleChange(e){return t=>{switch(e){case"visibility":return void this.setState({artifact:Object.assign(Object.assign({},this.state.artifact),{visibility:t.target.value})});case"enable_requests":return void this.setState({artifact:Object.assign(Object.assign({},this.state.artifact),{reproducibility:Object.assign(Object.assign({},this.state.artifact.reproducibility),{enable_requests:t.target.checked})})});case"access_hours":return void this.setState({artifact:Object.assign(Object.assign({},this.state.artifact),{reproducibility:Object.assign(Object.assign({},this.state.artifact.reproducibility),{access_hours:t.target.value})})});default:return void this.setState({artifact:Object.assign(Object.assign({},this.state.artifact),{[e]:t.target.value})})}}}handleListChange(e){return t=>{this.setState({artifact:Object.assign(Object.assign({},this.state.artifact),{[e]:t})})}}async onSubmit(e){e.preventDefault();const t={currentState:k.SUCCESS,errorMessage:null};if("upload"===this.props.workflow){this.setState({currentState:k.WAITING,waitMessage:"Please wait while your artifact files are uploaded"});try{this.state.artifact.uuid?await this.props.artifactRegistry.newArtifactVersion(this.state.artifact):t.artifact=await this.props.artifactRegistry.createArtifact(this.state.artifact),this.setState(t)}catch(e){this.setState({currentState:k.ARTIFACT_FORM,errorMessage:`Failed to package artifact: ${e.message}`})}}else if("edit"===this.props.workflow){this.setState({currentState:k.WAITING,waitMessage:"Saving artifact"});try{await this.props.artifactRegistry.updateArtifact(this.state.artifact),this.setState(t)}catch(e){this.setState({currentState:k.ARTIFACT_FORM,errorMessage:`Failed to save artifact: ${e.message}`})}}}render(){const e={display:"none"},t={display:"block"},n=this._allStates.reduce(((n,i)=>(n[i]=this.state.currentState===i?t:e,n)),{});let i,a;return"upload"===this.props.workflow?this.props.initialArtifact.uuid?(i=I.createElement(B,{urlFactory:this.props.urlFactory}),a=I.createElement(T,{urlFactory:this.props.urlFactory,artifact:this.state.artifact})):(i=I.createElement(F,{urlFactory:this.props.urlFactory}),a=I.createElement(x,{urlFactory:this.props.urlFactory,artifact:this.state.artifact})):(i=I.createElement(N,{urlFactory:this.props.urlFactory}),a=I.createElement(R,{urlFactory:this.props.urlFactory,artifact:this.state.artifact})),I.createElement("div",{className:"chi-Expand"},I.createElement("div",{className:"chi-ArtifactSharing-Form",style:n[k.ARTIFACT_FORM]},this.state.currentState===k.ARTIFACT_FORM&&I.createElement(M,{artifact:this.state.artifact,workflow:this.props.workflow,formVisibility:n[k.ARTIFACT_FORM],formText:i,onChange:this.handleChange,onListChange:this.handleListChange,onSubmit:this.onSubmit,error:this.state.errorMessage})),I.createElement("div",{className:"chi-ArtifactSharing-Form",style:n[k.WAITING]},I.createElement("div",{className:"jp-Spinner"},I.createElement("div",{className:"jp-SpinnerContent"}),I.createElement("div",{className:"chi-ArtifactSharing-LoadingMessage"},this.state.waitMessage))),I.createElement("div",{className:"chi-ArtifactSharing-Form",style:n[k.SUCCESS]},this.state.errorMessage&&I.createElement("div",{className:"chi-ArtifactSharing-ErrorMessage"},this.state.errorMessage),a))}}class L extends a.ReactWidget{constructor(e,t,n,i){super(),this.id="artifact-sharing-Widget",this._artifact=e,this._workflow=t,this._urlFactory=n,this._artifactRegistry=i}render(){return I.createElement(O,{initialArtifact:this._artifact,workflow:this._workflow,urlFactory:this._urlFactory,artifactRegistry:this._artifactRegistry,onCancel:this.dispose.bind(this)})}}const D="@chameleoncloud/jupyterlab-chameleon",P=`${D}:artifact-sharing`,V=`${D}:file-browser-factory`,q=`${D}:artifact-registry`;class H{constructor(e){this._settings=e}indexUrl(){return this._baseUrl}detailUrl(e){return this._makeUrl("externalDetailEndpoint").replace("{externalId}",e)}createUrl(e,t){return this._makeUrl("externalCreateEndpoint").replace("{depositionId}",e).replace("{depositionRepo}",t)}updateUrl(e){return this._makeUrl("externalUpdateEndpoint").replace("{externalId}",e)}newVersionUrl(e,t,n){return this._makeUrl("externalNewVersionEndpoint").replace("{externalId}",e).replace("{depositionId}",t).replace("{depositionRepo}",n)}isExternalUrl(e){return 0===this._baseUrl.indexOf(e)}get _baseUrl(){return this._settings.get("externalBaseUrl").composite}_makeUrl(e){const t=this._settings.get(e).composite;return this._baseUrl+t}}const $={id:P,requires:[d.ISettingRegistry,a.ICommandPalette,i.ILayoutRestorer,l.IMainMenu,s.IFileBrowserFactory,E],activate(e,t,n,i,r,s,o){Promise.all([t.load(P),e.restored,o.getArtifacts().catch((e=>(console.error("Error fetching list of local artifacts, defaulting to empty list."),[])))]).then((async([t])=>{const c=s.defaultBrowser,l=new a.WidgetTracker({namespace:"artifact-sharing"}),d=new G(c,o),h=function(e,t,n,i,r){let s;return async o=>{const c=await r.currentItemArtifact();if(!s||s.isDisposed){const e=new H(t),n=new L(c,o,e,i);n.title.label="upload"===o?"Package artifact":"Edit artifact",s=new a.MainAreaWidget({content:n}),s.id="artifact-sharing"}s.isAttached||e.shell.add(s,"main"),n.has(s)||await n.add(s),s.update(),e.shell.activateById(s.id)}}(e,t,l,o,d),u=()=>{const e=d.currentItem();return d.canBeArtifact(e)&&d.isOwnedArtifact(e)};e.commands.addCommand(W.create,{label:"Package as new artifact",isEnabled:()=>{const e=d.currentItem();return d.canBeArtifact(e)&&!d.isOwnedArtifact(e)},async execute(){await h("upload")}}),e.commands.addCommand(W.newVersion,{label:"Create new artifact version",isEnabled:u,async execute(){await h("upload")}}),e.commands.addCommand(W.edit,{label:"Edit artifact",isEnabled:u,async execute(){await h("edit")}}),function(e,t){const n=new m.Menu({commands:e.commands});n.addItem({command:W.create}),n.addItem({command:W.edit}),n.addItem({command:W.newVersion}),n.title.label="Share",t.addMenu(n,{rank:20})}(e,r),function(e){const t=".jp-DirListing-item[data-isdir=true][data-artifact-id]";e.contextMenu.addItem({command:W.create,selector:".jp-DirListing-item[data-isdir=true]:not([data-artifact-id])",rank:1}),e.contextMenu.addItem({command:W.edit,selector:t,rank:1}),e.contextMenu.addItem({command:W.newVersion,selector:t,rank:2})}(e),function(e){const t="Sharing";e.addItem({command:W.create,category:t}),e.addItem({command:W.edit,category:t}),e.addItem({command:W.newVersion,category:t})}(n),await i.restore(l,{command:W.create,name:()=>"artifact-sharing"})})).catch((e=>{console.trace(),console.error(e.message)}))},autoStart:!0};var W;!function(e){e.create="artifact-sharing:create",e.edit="artifact-sharing:edit",e.newVersion="artifact-sharing:newVersion"}(W||(W={}));class G{constructor(e,t){this._browser=e,this._artifactRegistry=t}canBeArtifact(e){return e&&"directory"===e.type}isOwnedArtifact(e){const t=this._artifactRegistry.getArtifactSync(e.path);return t&&"own"===t.ownership}async currentItemArtifact(){const e=this.currentItem();if(!e||"directory"!==e.type)return null;let t=await this._artifactRegistry.getArtifact(e.path);return t||(t={title:"",short_description:"",authors:[],linked_projects:[],reproducibility:{enable_requests:!1},tags:[],versions:[],newLinks:[],path:e.path,ownership:"fork"}),t}currentItem(){const e=(0,p.toArray)(this._browser.selectedItems());return e.length>1?null:1===e.length?e[0]:this._fakeCurrentRootItem()}_fakeCurrentRootItem(){const{path:e}=this._browser.model;return{content:null,created:null,format:"json",last_modified:null,mimetype:null,name:e,path:e,type:"directory",writable:!0}}}const K=[$,{id:V,provides:s.IFileBrowserFactory,requires:[r.IDocumentManager,u.ITranslator,E],optional:[h.IStateDB,i.IRouter,i.JupyterFrontEnd.ITreeResolver],activate:async(e,t,n,i,a,r,o)=>(s.DirListing.defaultRenderer=new g(i),c().find((({id:e})=>"@jupyterlab/filebrowser-extension:factory"===e)).activate(e,t,n,a,r,o))},{id:q,provides:E,requires:[],activate:e=>new w}];var Y,z=n(931);class J{constructor(e){this._commands=null,this._heartbeatTimer=null,this._interval=6e4,this._serverSettings=f.ServerConnection.makeSettings(),this._commands=e}start(){this.stop(),this._heartbeatTimer=window.setInterval((async()=>{await this._beat()}),this._interval),this._beat()}stop(){window.clearTimeout(this._heartbeatTimer)}async _beat(){const e=await f.ServerConnection.makeRequest(Y.getUrl(this._serverSettings),{method:"GET"},this._serverSettings),t=await e.json();200===e.status?console.debug(`Session ok until ${t.expires_at}`):401===e.status?(this.stop(),t.reauthenticate_link?await this._reauthenticate(t.reauthenticate_link):(console.warn("User backend session timed out, yet there was no reauthenticate link provided."),this._commands.execute(z.CommandIDs.logout))):405===e.status&&(this.stop(),console.debug("Disabling session heartbeat; hearbeat not supported."))}async _reauthenticate(e){const t=new a.Dialog({title:"Your Chameleon session has timed out.",body:"We will attempt to automatically reconnect you.",buttons:[a.Dialog.okButton({label:"Continue"})]}),n=await t.launch();t.dispose(),n.button.accept&&(e=`${e}?next=${document.location.pathname}`,document.location.href=e)}}!function(e){e.getUrl=function(e){const t=[e.baseUrl,"chameleon","heartbeat"];return y.URLExt.join.call(y.URLExt,...t)}}(Y||(Y={}));const Z={activate(e){Promise.all([e.restored]).then((async()=>{new J(e.commands).start()})).catch((e=>{console.error(e)}))},id:"@chameleoncloud/jupyterlab-chameleon:sessionHeartbeatPlugin",autoStart:!0};var Q=n(503),X=n(129);class ee extends m.Widget{constructor(e,t,n,i){super(),this.addClass("chi-HydraBindings"),t.currentChanged.connect(this._onCurrentChanged,this),this._currentNotebook=t.currentWidget,this._bindingRegistry=n,this._labshell=e,this.translator=i||u.nullTranslator,this._trans=this.translator.load("jupyterlab");const a=this.layout=new m.SingletonLayout,r=document.createElement("div"),s=document.createElement("div");s.textContent=this._trans.__("Please select a Notebook that utilizes the Hydra kernel to see subkernel statuses."),s.className="chi-HydraBindings-placeholderContent",r.appendChild(s),this._placeholder=new m.Widget({node:r}),this._placeholder.addClass("chi-HydraBindings-placeholder"),a.widget=this._placeholder,this.refresh()}_onCurrentChanged(e,t){this._currentNotebook&&this._currentNotebook.sessionContext.kernelChanged.disconnect(this._onKernelChanged,this),this._currentNotebook=t,this._currentNotebook.sessionContext.kernelChanged.connect(this._onKernelChanged,this),this.refresh()}_onKernelChanged(e,t){this.refresh()}refresh(){var e,t;const n=null===(t=null===(e=this._currentNotebook)||void 0===e?void 0:e.sessionContext.session)||void 0===t?void 0:t.kernel;n&&"hydra"===n.name?(console.log("hydra kernel detected"),this.setContent(new te(this._bindingRegistry.getBindings(n)))):this.setContent(null)}setContent(e){const t=this.layout;t.widget&&(t.widget.removeClass("chi-HydraBindings-content"),t.removeWidget(t.widget)),e||(e=this._placeholder),e.addClass("chi-HydraBindings-content"),t.widget=e}showPanel(){this._labshell.activateById(this.id)}}class te extends a.ReactWidget{constructor(e){super(),this._bindings=e}render(){return I.createElement(ne,{bindings:this._bindings})}dispose(){super.dispose(),this._bindings=null}}class ne extends I.Component{constructor(e){super(e),this.state={bindings:(0,p.toArray)(e.bindings.iter())},e.bindings.changed.connect(this.onBindingsChanged,this)}onBindingsChanged(e){this.setState({bindings:(0,p.toArray)(e.iter())})}render(){return I.createElement("div",{className:"chi-BindingStatus"},I.createElement("div",{className:"chi-BindingStatus-header"},"Subkernels"),this.state.bindings.map((e=>I.createElement(ie,{binding:e}))))}componentWillUnmount(){this.props.bindings.changed.disconnect(this.onBindingsChanged,this)}}class ie extends I.Component{constructor(){super(...arguments),this.state={isOpen:!1},this.handleClick=()=>{this.setState({isOpen:!this.state.isOpen})}}render(){const e=this.props.binding,t=e.connection,n=I.createElement("div",null,"Connection: ",t.type,I.createElement("br",null),"Kernel: ",e.kernel);let i,a,r;switch(e.connection.type){case"local":default:break;case"ssh":a=t,i=I.createElement("div",null,"SSH: ",I.createElement("span",null,a.user,"@"),I.createElement("span",null,a.host),I.createElement("br",null),"Identity file: ",a.privateKeyFile);break;case"zun":r=t,i=I.createElement("div",null,"Container: ",r.containerUuid)}const s={width:100*(e.progress.progressRatio||0)+"%"},o="idle"===(e.progress.progress||"").toLowerCase()?A.circleEmptyIcon:A.circleIcon,c="connected"===e.state?o:A.offlineBoltIcon;return I.createElement("div",{className:"chi-Binding",onClick:this.handleClick},I.createElement("div",{className:"chi-BindingSummary"},I.createElement("div",{className:"chi-BindingSummary-status"},I.createElement(c.react,null)),I.createElement("div",{className:"chi-BindingSummary-summary"},I.createElement("div",{className:"chi-Binding-name"},e.name),I.createElement("div",{className:`chi-BindingState-${e.state}`},e.state),I.createElement("div",{className:"chi-BindingState-progress"},e.progress.progress,e.progress.progressRatio&&I.createElement("div",{className:"chi-BindingState-progressBarContainer"},I.createElement("span",{className:"chi-BindingState-progressBar",style:s}))))),I.createElement(A.Collapse,{keepChildrenMounted:!0,isOpen:this.state.isOpen},I.createElement("div",{className:"chi-BindingConnection"},I.createElement("div",{className:"chi-BindingConnection-header"},"Connection details"),n,i)))}}const ae=new C.Token("@chameleoncloud/jupyter-chameleon:IBindingRegistry"),re="chameleon.binding_name";class se{constructor(){this.isDisposed=!1,this._onBindingNameChangeHandlers=new Map}hasBinding(e){return e.metadata.has(re)}setBindingName(e,t){e.metadata.set(re,t)}removeBinding(e){e.metadata.delete(re)}getBindingName(e){return e.metadata.get(re)}onBindingNameChanged(e,t){const n=(e,n)=>{n.key===re&&t()};e.metadata.changed.connect(n);const i=this._onBindingNameChangeHandlers.get(e)||[];this._onBindingNameChangeHandlers.set(e,i.concat([n]))}dispose(){this._onBindingNameChangeHandlers.forEach(((e,t)=>{e.forEach((e=>t.metadata.changed.disconnect(e)))})),this.isDisposed=!0}}var oe;!function(e){e.updateCellBinding=function(e,t,n){e.model&&e.activeCell&&t.setBindingName(e.activeCell.model,n)},e.removeCellBinding=function(e,t){e.model&&e.activeCell&&t.removeBinding(e.activeCell.model)}}(oe||(oe={}));class ce extends a.ReactWidget{constructor(e,t){super(),this.handleChange=e=>{"-"===e.target.value?oe.removeCellBinding(this._notebook,this._cellMeta):oe.updateCellBinding(this._notebook,this._cellMeta,e.target.value),this._notebook.activate(),this.update()},this.handleKeyDown=e=>{13===e.keyCode&&this._notebook.activate()},this._notebook=null,this._cellMeta=null,this._bindingList=[],this.addClass("chi-Notebook-toolbarCellBindingDropdown"),this._notebook=e,this._cellMeta=t,e.model&&this.update(),e.activeCellChanged.connect(this.update,this),e.selectionChanged.connect(this.update,this)}updateBindings(e){this._bindingList=(0,p.toArray)(e.iter()),this.update()}dispose(){super.dispose(),this._bindingList=[]}render(){let e="-";if(this._notebook.activeCell){const t=this._notebook.activeCell.model;this._cellMeta.hasBinding(t)&&(e=this._cellMeta.getBindingName(t))}return I.createElement(A.HTMLSelect,{onChange:this.handleChange,onKeyDown:this.handleKeyDown,value:e,icon:A.caretDownIcon,"aria-label":"Binding"},I.createElement("option",{value:"-"},"META"),this._bindingList.map((({name:e})=>I.createElement("option",{key:e,value:e},e))))}}var le,de=n(464);class he{constructor(){this.isDisposed=!1,this._bindings=new Map}dispose(){this.isDisposed=!0}register(e){if(this._bindings.has(e))return this._bindings.get(e).bindings;const t=()=>{const t=e.createComm("hydra");return t.onMsg=this._onCommMsg.bind(this),t.open(),t},n={bindings:new de.ObservableList,comm:null},i=(e,i)=>{"connected"===i&&(n.comm&&n.comm.dispose(),n.comm=t(),n.comm.send({event:"binding_list_request",bindings:(0,p.toArray)(n.bindings)}))};e.connectionStatusChanged.connect(i);const a=()=>{console.log("kernel disposed"),e.disposed.disconnect(a),e.connectionStatusChanged.disconnect(i),this.unregister(e)};return e.disposed.connect(a),this._bindings.set(e,n),n.bindings}unregister(e){if(!this._bindings.has(e))return;const{comm:t,bindings:n}=this._bindings.get(e);n.dispose(),t&&(t.onMsg=null,t.close()),this._bindings.delete(e)}getBindings(e){if(!this._bindings.has(e))throw new Error("Kernel not registered");return this._bindings.get(e).bindings}_findTrackerByCommId(e){var t;for(const n of this._bindings.values())if((null===(t=n.comm)||void 0===t?void 0:t.commId)===e)return n;return null}_onCommMsg(e){var t,n;const i=null===(t=null==e?void 0:e.content)||void 0===t?void 0:t.comm_id;if(!i)return void console.log("Ignoring message without comm_id",e);const a=this._findTrackerByCommId(i);if(!a)return void console.log("Ignoring message from untracked comm",e);const r=null===(n=null==e?void 0:e.content)||void 0===n?void 0:n.data,{event:s}=r||{};function o(){const e=r.binding,t=(0,p.findIndex)(a.bindings.iter(),(({name:t},n)=>t===e.name));return[e,t]}let c=null,l=-1;switch(s){case"binding_list_reply":a.bindings.clear(),a.bindings.pushAll(r.bindings);break;case"binding_update":[c,l]=o(),l>-1?a.bindings.set(l,c):a.bindings.push(c);break;case"binding_remove":[c,l]=o(),l>-1&&a.bindings.remove(l)}}}!function(e){e.BindingTracker=class{}}(le||(le={}));const ue=[...Array(10).keys()].map((e=>`chi-binding-${e}`));class pe{constructor(e){this.registry=e}createNew(e,t){const n=new se,i=new ce(e.content,n);let a;e.toolbar.insertBefore("spacer","changeBinding",i),e.content.activeCellChanged.connect(((e,t)=>{i.setHidden(!!t&&"code"!==t.model.type)}));const r=(t,r)=>{i.updateBindings(a),e.content.widgets.forEach((e=>{"code"===e.model.type&&ge.updateCellDisplay(e,n,a)}))},s=(e,t)=>{a&&(a.changed.disconnect(r),a=null),t.newValue&&(a=this.registry.register(t.newValue),a.changed.connect(r))},o=(t,i)=>{const r=t.get(i.newIndex);if("add"!==i.type||"code"!==r.type)return;const s=e.content.widgets.find((e=>e.model===r));if(n.onBindingNameChanged(r,(()=>{ge.updateCellDisplay(s,n,a)})),i.newIndex>0&&!r.value.text.length&&!n.hasBinding(r)){const e=t.get(i.newIndex-1),a=n.getBindingName(e);a&&n.setBindingName(r,a)}};return e.model.cells.changed.connect(o),e.sessionContext.kernelChanged.connect(s),new X.DisposableDelegate((()=>{e.model.cells.changed.disconnect(o),e.sessionContext.kernelChanged.disconnect(s),a&&a.changed.disconnect(r),n.dispose(),i.dispose()}))}}const me={id:"@chameleoncloud/jupyterlab-chameleon:hydra-notebook",autoStart:!0,requires:[ae],activate(e,t){e.docRegistry.addWidgetExtension("Notebook",new pe(t))}};var ge;!function(e){e.updateCellDisplay=function(e,t,n){ue.forEach((t=>e.removeClass(t)));const i=t.getBindingName(e.model),a=(0,p.findIndex)(n.iter(),(({name:e},t)=>e===i));if(a>-1){const t=n.get(a);e.addClass(ue[a%ue.length]),e.editor.model.mimeType=t.mimeType||"shell"}else e.editor.model.mimeType="python"}}(ge||(ge={}));const fe=[me,{id:"@chameleoncloud/jupyterlab-chameleon:binding-registry",autoStart:!0,provides:ae,activate:()=>new he},{id:"@chameleoncloud/jupyterlab-chameleon:hydra-bindings",autoStart:!0,requires:[i.ILabShell,Q.INotebookTracker,ae,u.ITranslator],optional:[i.ILayoutRestorer],activate:(e,t,n,i,a,r)=>{const s=a.load("jupyterlab"),o=new ee(t,n,i,a);o.title.icon=A.offlineBoltIcon,o.title.caption=s.__("Hydra Subkernels"),o.id="chi-hydra-bindings",t.add(o,"right",{rank:100}),r&&r.add(o,"chi-hydra-bindings")}}],ye=[];K.forEach((e=>ye.push(e))),ye.push(Z),fe.forEach((e=>ye.push(e)));const be=ye}}]);