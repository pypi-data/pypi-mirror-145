$(document).ready(()=>{"use strict";const checkboxPrePing=$("input#prePing");const checkboxFormupTimeNow=$("input#formupTimeNow");const checkboxCreateSrpLink=$("input#createSrpLink");const checkboxCreateOptimer=$("input#createOptimer");const selectPingTarget=$("select#pingTarget");const selectPingChannel=$("select#pingChannel");const selectFleetType=$("select#fleetType");const selectFleetSrp=$("select#fleetSrp");const inputFcName=$("input#fcName");const inputFleetName=$("input#fleetName");const inputFormupLocation=$("input#formupLocation");const inputFormupTime=$("input#formupTime");const inputFleetComms=$("input#fleetComms");const inputFleetDoctrine=$("input#fleetDoctrine");const inputCsrfMiddlewareToken=$('input[name="csrfmiddlewaretoken"]');const textAdditionalInformation=$("textarea#additionalInformation");const nl2br=(string,isXhtml)=>{const breakTag=isXhtml||typeof isXhtml==="undefined"?"<br />":"<br>";return(string+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+breakTag+"$2")};const closeMessageElement=(element,closeAfter=10)=>{$(element).fadeTo(closeAfter*1e3,500).slideUp(500,()=>{$(this).slideUp(500,()=>{$(this).remove()})})};const showSuccess=(message,element)=>{$(element).html('<div class="alert alert-success alert-dismissable alert-message-success">'+'<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>'+message+"</div>");closeMessageElement(".alert-message-success")};const showError=(message,element)=>{$(element).html('<div class="alert alert-danger alert-dismissable alert-message-error">'+'<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>'+message+"</div>");closeMessageElement(".alert-message-error",9999)};const sanitizeInput=input=>{if(input){return input.replace(/<(|\/|[^>\/bi]|\/[^>bi]|[^\/>][^>]+|\/[^>][^>]+)>/g,"")}else{return input}};const escapeInput=(input,quotesToEntities)=>{quotesToEntities=quotesToEntities||false;if(input){let returnValue=sanitizeInput(input).replace(/&/g,"&amp;");if(quotesToEntities===true){returnValue=returnValue.replace(/"/g,"&quot;")}if(quotesToEntities===false){returnValue=returnValue.replace(/"/g,'\\"')}return returnValue}else{return input}};const sendEmbeddedDiscordPing=(webhookUrl,content,embeds)=>{const request=new XMLHttpRequest;request.open("POST",webhookUrl);request.setRequestHeader("Content-type","application/json");const params={username:"",avatar_url:"",content:content,embeds:[embeds]};request.send(JSON.stringify(params))};const sendDiscordPing=(webhookUrl,pingText)=>{const request=new XMLHttpRequest;request.open("POST",webhookUrl);request.setRequestHeader("Content-type","application/json");const params={username:"",avatar_url:"",content:pingText};request.send(JSON.stringify(params))};const sendSlackPing=(webhookUrl,payload)=>{$.ajax({data:"payload="+JSON.stringify(payload),dataType:"json",processData:false,type:"POST",url:webhookUrl})};const hexToDecimal=hexValue=>{return parseInt(hexValue.replace("#",""),16)};const getFormupTimestamp=formupTime=>{const formupDateTime=new Date(formupTime);return(formupDateTime.getTime()-formupDateTime.getTimezoneOffset()*60*1e3)/1e3};const getTimezonesUrl=formupTime=>{const formupTimestamp=getFormupTimestamp(formupTime);return fleetpingsSettings.siteUrl+fleetpingsSettings.timezonesUrl+formupTimestamp+"/"};const generateFleetPing=fleetSrpCode=>{const pingTargetSelected=$("option:selected",selectPingTarget);const pingTarget=sanitizeInput(pingTargetSelected.val());const pingTargetText=sanitizeInput(pingTargetSelected.text());const pingChannelSelected=$("option:selected",selectPingChannel);const webhookType=sanitizeInput(pingChannelSelected.data("webhook-type"));const webhookEmbedPing=sanitizeInput(pingChannelSelected.data("webhook-embed"));const fleetTypeSelected=$("option:selected",selectFleetType);const fleetType=sanitizeInput(fleetTypeSelected.val());const webhookEmbedColor=sanitizeInput(fleetTypeSelected.data("embed-color"));const fcName=sanitizeInput(inputFcName.val());const fleetName=sanitizeInput(inputFleetName.val());const formupLocation=sanitizeInput(inputFormupLocation.val());const formupTime=sanitizeInput(inputFormupTime.val());const fleetComms=sanitizeInput(inputFleetComms.val());const fleetDoctrine=sanitizeInput(inputFleetDoctrine.val());const fleetSrp=sanitizeInput($("option:selected",selectFleetSrp).val());const additionalInformation=sanitizeInput(textAdditionalInformation.val());let fleetDoctrineLink=null;if(fleetDoctrine!==""){const selectedLink=$('#fleetDoctrineList [value="'+escapeInput(fleetDoctrine,false)+'"]').data("doctrine-url");if("undefined"!==selectedLink&&selectedLink!==""){fleetDoctrineLink=selectedLink}}let webhookUrl="";if(selectPingChannel.length){webhookUrl=sanitizeInput(pingChannelSelected.val())}$(".aa-fleetpings-no-ping").hide("fast");$(".aa-fleetpings-ping").show("fast");let webhookPingTextHeader="";let webhookPingTextContent="";let webhookPingTextFooter="";let pingText="";let discordPingTarget="";let webhookPingTarget="";if(pingTarget!==""){if(pingTarget.indexOf("@")>-1){webhookPingTarget=pingTarget}else{webhookPingTarget="<@&"+pingTarget+">"}if(pingTargetText.indexOf("@")>-1){discordPingTarget=pingTargetText}else{discordPingTarget="@"+pingTargetText}pingText+=" :: "}pingText+="**";if(checkboxPrePing.is(":checked")){pingText+="### PRE PING ###";webhookPingTextHeader+="### PRE PING ###";if(fleetType!==""){pingText+=" / (Upcoming)  "+fleetType+" Fleet";webhookPingTextHeader+=" / (Upcoming) "+fleetType+" Fleet"}}else{if(fleetType!==""){pingText+=fleetType+" ";webhookPingTextHeader+=fleetType+" "}pingText+="Fleet is up";webhookPingTextHeader+="Fleet is up"}if(fcName!==""){pingText+=" under "+fcName;webhookPingTextHeader+=" under "+fcName}pingText+="**"+"\n";if(fcName!==""){pingText+="\n"+"**FC:** "+fcName;webhookPingTextContent+="\n"+"**FC:** "+fcName}if(fleetName!==""){pingText+="\n"+"**Fleet Name:** "+fleetName;webhookPingTextContent+="\n"+"**Fleet Name:** "+fleetName}if(formupLocation!==""){pingText+="\n"+"**Formup Location:** "+formupLocation;webhookPingTextContent+="\n"+"**Formup Location:** "+formupLocation}if(checkboxFormupTimeNow.is(":checked")){pingText+="\n"+"**Formup Time:** NOW";webhookPingTextContent+="\n"+"**Formup Time:** NOW"}else{if(formupTime!==""){pingText+="\n"+"**Formup (EVE Time):** "+formupTime;webhookPingTextContent+="\n"+"**Formup (EVE Time):** "+formupTime;if(fleetpingsSettings.timezonesInstalled===true){const timezonesUrl=getTimezonesUrl(formupTime);pingText+=" - "+timezonesUrl;if(webhookType==="Discord"){webhookPingTextContent+=" ([Time Zone Conversion]("+timezonesUrl+"))"}if(webhookType==="Slack"){webhookPingTextContent+=" (<"+timezonesUrl+"|Time Zone Conversion>)"}}const formupTimestamp=getFormupTimestamp(formupTime);pingText+="\n"+"**Formup (Local Time):** &lt;t:"+formupTimestamp+":F&gt;";webhookPingTextContent+="\n"+"**Formup (Local Time):** <t:"+formupTimestamp+":F>"}}if(fleetComms!==""){pingText+="\n"+"**Comms:** "+fleetComms;webhookPingTextContent+="\n"+"**Comms:** "+fleetComms}if(fleetDoctrine!==""){pingText+="\n"+"**Ships / Doctrine:** "+fleetDoctrine;webhookPingTextContent+="\n"+"**Ships / Doctrine:** "+fleetDoctrine;if(fleetDoctrineLink!==null){pingText+=" - "+fleetDoctrineLink;if(webhookType==="Discord"){webhookPingTextContent+=" ([Doctrine Link]("+fleetDoctrineLink+"))"}if(webhookType==="Slack"){webhookPingTextContent+=" (<"+fleetDoctrineLink+"|Doctrine Link>)"}}}if(fleetSrp!==""){pingText+="\n"+"**SRP:** "+fleetSrp;webhookPingTextContent+="\n"+"**SRP:** "+fleetSrp;if(fleetSrp==="Yes"&&fleetSrpCode!==""){pingText+=" (SRP Code: "+fleetSrpCode+")";webhookPingTextContent+=" (SRP Code: "+fleetSrpCode+")"}}if(additionalInformation!==""){pingText+="\n\n"+"**Additional Information**:"+"\n"+additionalInformation;webhookPingTextContent+="\n\n"+"**Additional Information**:"+"\n"+additionalInformation}if(fleetpingsSettings.platformUsed==="Discord"){$(".aa-fleetpings-ping-text").html("<p>"+nl2br(discordPingTarget+pingText,false)+"</p>")}if(fleetpingsSettings.platformUsed==="Slack"){$(".aa-fleetpings-ping-text").html("<p>"+nl2br(discordPingTarget+pingText.split("**").join("*"),false)+"</p>")}if(webhookUrl!==""){if(fleetpingsSettings.pingCreator!==""){pingText+="\n\n"+"*(Ping sent by: "+fleetpingsSettings.pingCreator+")*";webhookPingTextFooter="(Ping sent by: "+fleetpingsSettings.pingCreator+")"}let embedColor="#faa61a";if(fleetType!==""&&embedColor!==""){embedColor=webhookEmbedColor}if(webhookType==="Discord"){if("undefined"!==webhookEmbedPing&&webhookEmbedPing==="True"){if(pingTarget!==""){webhookPingTarget+=" :: "}sendEmbeddedDiscordPing(webhookUrl,webhookPingTarget+"**"+webhookPingTextHeader+"**"+"\n"+"** **",{title:"**.: Fleet Details :.**",description:webhookPingTextContent,color:hexToDecimal(embedColor),footer:{text:webhookPingTextFooter}})}else{sendDiscordPing(webhookUrl,webhookPingTarget+pingText)}}if(webhookType==="Slack"){let slackEmbedPingTarget="";if(pingTarget!==""){slackEmbedPingTarget="<"+webhookPingTarget.replace("@","!")+"> :: "}const payload={attachments:[{fallback:pingText,color:embedColor,pretext:slackEmbedPingTarget+"*"+webhookPingTextHeader+"*",text:"*.: Fleet Details :.*"+"\n"+webhookPingTextContent.split("**").join("*"),footer:webhookPingTextFooter}]};sendSlackPing(webhookUrl,payload)}showSuccess(fleetpingsTranslations.ping.success,".aa-fleetpings-ping-copyresult")}};const generateFleetPingWithSrp=(fleetName,fleetDoctrine)=>{if(fleetpingsSettings.srpModuleAvailableToUser===true){if(fleetName!==""&&fleetDoctrine!==""){const srpAjaxUrl=fleetpingsSettings.srpAjaxUrl;let srpCode="";$.ajax({url:srpAjaxUrl,type:"post",data:{fleet_doctrine:fleetDoctrine,fleet_name:fleetName},headers:{"X-CSRFToken":sanitizeInput(inputCsrfMiddlewareToken.val())}}).done(result=>{srpCode=result.srp_code;generateFleetPing(srpCode);closeMessageElement(".alert-message-error",0);showSuccess(fleetpingsTranslations.srp.created,".fleetpings-create-srp-link-message")});checkboxCreateSrpLink.prop("checked",false)}else{showError(fleetpingsTranslations.srp.error.missingFields,".fleetpings-create-srp-link-message")}return true}else{return false}};const generateFleetPingWithOptimer=(fleetName,fleetDoctrine,formupLocation,formupTime,fcName)=>{if(fleetpingsSettings.optimerInstalled===true){if(fleetName!==""&&fleetDoctrine!==""&&formupLocation!==""&&formupTime!==""&&fcName!==""){const optimerAjaxUrl=fleetpingsSettings.optimerAjaxUrl;$.ajax({url:optimerAjaxUrl,type:"post",data:{fleet_doctrine:fleetDoctrine,formup_location:formupLocation,formup_time:formupTime,fleet_name:fleetName,fleet_commander:fcName},headers:{"X-CSRFToken":inputCsrfMiddlewareToken.val()}});checkboxCreateOptimer.prop("checked",false);generateFleetPing("");closeMessageElement(".alert-message-error",0);showSuccess(fleetpingsTranslations.optimer.created,".fleetpings-create-optimer-message")}else{showError(fleetpingsTranslations.optimer.error.missingFields,".fleetpings-create-optimer-message")}return true}else{return false}};const copyFleetPing=()=>{const clipboardFleetPingData=new ClipboardJS("button#copyFleetPing");clipboardFleetPingData.on("success",e=>{showSuccess(fleetpingsTranslations.copyToClipboard.success,".aa-fleetpings-ping-copyresult");e.clearSelection();clipboardFleetPingData.destroy()});clipboardFleetPingData.on("error",()=>{showError(fleetpingsTranslations.copyToClipboard.error,".aa-fleetpings-ping-copyresult");clipboardFleetPingData.destroy()})};if(fleetpingsSettings.srpModuleAvailableToUser===true){if(sanitizeInput($("option:selected",selectFleetSrp).val())==="Yes"&&checkboxFormupTimeNow.is(":checked")){$(".fleetpings-create-srp-link").show("fast")}else{checkboxCreateSrpLink.prop("checked",false);$(".fleetpings-create-srp-link").hide("fast")}selectFleetSrp.change(()=>{if(sanitizeInput($("option:selected",selectFleetSrp).val())==="Yes"&&checkboxFormupTimeNow.is(":checked")){$(".fleetpings-create-srp-link").show("fast")}else{checkboxCreateSrpLink.prop("checked",false);$(".fleetpings-create-srp-link").hide("fast")}})}checkboxPrePing.on("change",()=>{if(checkboxPrePing.is(":checked")){checkboxFormupTimeNow.prop("checked",false);inputFormupTime.prop("disabled",false);if(fleetpingsSettings.optimerInstalled===true){$(".fleetpings-create-optimer").show("fast")}if(fleetpingsSettings.srpModuleAvailableToUser===true){checkboxCreateSrpLink.prop("checked",false);$(".fleetpings-create-srp-link").hide("fast")}}else{checkboxFormupTimeNow.prop("checked",true);inputFormupTime.prop("disabled",true);if(fleetpingsSettings.optimerInstalled===true){checkboxCreateOptimer.prop("checked",false);$(".fleetpings-create-optimer").hide("fast")}if(fleetpingsSettings.srpModuleAvailableToUser===true&&sanitizeInput($("option:selected",selectFleetSrp).val())==="Yes"){$(".fleetpings-create-srp-link").show("fast")}}});checkboxFormupTimeNow.on("change",()=>{if(checkboxFormupTimeNow.is(":checked")){checkboxPrePing.prop("checked",false);inputFormupTime.prop("disabled",true);if(fleetpingsSettings.optimerInstalled===true){checkboxCreateOptimer.prop("checked",false);$(".fleetpings-create-optimer").hide("fast")}if(fleetpingsSettings.srpModuleAvailableToUser===true&&sanitizeInput($("option:selected",selectFleetSrp).val())==="Yes"){$(".fleetpings-create-srp-link").show("fast")}}else{checkboxPrePing.prop("checked",true);inputFormupTime.prop("disabled",false);if(fleetpingsSettings.optimerInstalled===true){$(".fleetpings-create-optimer").show("fast")}if(fleetpingsSettings.srpModuleAvailableToUser===true){checkboxCreateSrpLink.prop("checked",false);$(".fleetpings-create-srp-link").hide("fast")}}});$("button#createPingText").on("click",()=>{const fleetName=sanitizeInput(inputFleetName.val());const fleetDoctrine=sanitizeInput(inputFleetDoctrine.val());const formupTime=sanitizeInput(inputFormupTime.val());const fcName=sanitizeInput(inputFcName.val());const formupLocation=sanitizeInput(inputFormupLocation.val());let pingCreated=false;if(checkboxCreateSrpLink.is(":checked")&&checkboxFormupTimeNow.is(":checked")){pingCreated=generateFleetPingWithSrp(fleetName,fleetDoctrine)}if(checkboxPrePing.is(":checked")&&checkboxCreateOptimer.is(":checked")){pingCreated=generateFleetPingWithOptimer(fleetName,fleetDoctrine,formupLocation,formupTime,fcName)}if(pingCreated===false){generateFleetPing("")}});$("button#copyFleetPing").on("click",()=>{copyFleetPing()})});